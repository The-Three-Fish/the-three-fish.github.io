<!DOCTYPE html><html lang="en"> <head><!-- favicon --><link rel="shortcut icon" href="/images/s-logo-blue.jpg"><!-- theme meta --><meta name="theme-name" content="bigspring-light-astro"><meta name="msapplication-TileColor" content="#000000"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#fff"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#000"><meta name="generator" content="Astro v4.16.19"><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><!-- google font css --><style>@font-face {font-weight: 300;font-style: normal;font-family: Lato;font-display: swap;src: url(https://fonts.gstatic.com/s/lato/v24/S6u9w4BMUTPHh7USew8.ttf)}</style><style>@font-face {font-weight: 400;font-style: normal;font-family: Lato;font-display: swap;src: url(https://fonts.gstatic.com/s/lato/v24/S6uyw4BMUTPHvxk.ttf)}</style><style>@font-face {font-weight: 700;font-style: normal;font-family: Lato;font-display: swap;src: url(https://fonts.gstatic.com/s/lato/v24/S6u9w4BMUTPHh6UVew8.ttf)}</style><style>:root{ --font-primary: Lato, '_font_fallback_1506814262248', sans-serif; } @font-face { font-family: '_font_fallback_1506814262248'; size-adjust: 97.84%; src: local('Arial'); ascent-override: 100.88%; descent-override: 21.77%; line-gap-override: 0.00%; }</style><!-- responsive meta --><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5"><!-- title --><title>
      oTree 新写法（New Format）一文看懂：从老格式到单文件、静态方法的过渡
    </title><!-- canonical url --><!-- noindex robots --><!-- meta-description --><meta name="description" content="otree 5带来了新的变化，跟我一起看有哪些要注意的地方"><meta name="astro-view-transitions-enabled" content="true"><meta name="astro-view-transitions-fallback" content="animate"><!-- author from config.json --><meta name="author" content="rowan2024"><!-- og-title --><meta property="og:title" content="oTree 新写法（New Format）一文看懂：从老格式到单文件、静态方法的过渡"><!-- og-description --><meta property="og:description" content="otree 5带来了新的变化，跟我一起看有哪些要注意的地方"><meta property="og:type" content="website"><meta property="og:url" content="https://the-three-fish.github.io/blog/new-format"><!-- twitter-title --><meta name="twitter:title" content="oTree 新写法（New Format）一文看懂：从老格式到单文件、静态方法的过渡"><!-- twitter-description --><meta name="twitter:description" content="otree 5带来了新的变化，跟我一起看有哪些要注意的地方"><!-- og-image --><meta property="og:image" content="https://the-three-fish.github.io/images/blog-4.jpg"><!-- twitter-image --><meta name="twitter:image" content="https://the-three-fish.github.io/images/blog-4.jpg"><meta name="twitter:card" content="summary_large_image"><link rel="stylesheet" href="/_astro/_regular_.ZsQVOST3.css"><script type="module" src="/_astro/hoisted.BT380aKz.js"></script></head> <body>  <header class="header"> <nav class="navbar container"> <!-- logo --> <div class="order-0"> <a href="/" class="navbar-brand block md:w-[150px] lg:w-auto"> <img src="/images/logo5.png" alt="oTree Study" style="height:38px;width:200px" width="400" height="76" loading="lazy" decoding="async"> </a> </div> <!-- navbar toggler --> <input id="nav-toggle" type="checkbox" class="hidden"> <label id="show-button" for="nav-toggle" class="order-2 flex cursor-pointer items-center md:order-1 md:hidden"> <svg class="h-6 fill-current" viewBox="0 0 20 20"> <title>Menu Open</title> <path d="M0 3h20v2H0V3z m0 6h20v2H0V9z m0 6h20v2H0V0z"></path> </svg> </label> <label id="hide-button" for="nav-toggle" class="order-2 cursor-pointer items-center md:order-1"> <svg class="h-6 fill-current" viewBox="0 0 20 20"> <title>Menu Close</title> <polygon points="11 9 22 9 22 11 11 11 11 22 9 22 9 11 -2 11 -2 9 9 9 9 -2 11 -2" transform="rotate(45 10 10)"></polygon> </svg> </label> <!-- /navbar toggler --> <ul id="nav-menu" class="navbar-nav order-3 hidden w-full md:order-1 md:flex md:w-auto md:space-x-3"> <li class="nav-item"> <a href="/" class="nav-link block false"> Home </a> </li><li class="nav-item"> <a href="/blog" class="nav-link block false"> Blog </a> </li><li class="nav-item"> <a href="/pricing" class="nav-link block false"> Pricing </a> </li><li class="nav-item"> <a href="/contact" class="nav-link block false"> Contact </a> </li><li class="nav-item"> <a href="/faq" class="nav-link block false"> FAQ </a> </li> <div class="block md:hidden"> <a class="btn btn-primary z-0 ml-auto py-[14px]" href="/contact"> Get Started </a> </div> </ul> <div class="order-1 ml-auto hidden items-center md:order-2 md:ml-0 md:flex md:min-w-[150px] lg:min-w-[200px]"> <a class="btn btn-primary z-0 ml-auto py-[14px]" href="/contact"> Get Started </a> </div> </nav> </header> <main id="main-content">  <section class="section"> <div class="container"> <div class="row justify-center"> <div class="col-12 md:col-8"> <article class="text-center"> <img src="/images/blog-4.jpg" alt="oTree 新写法（New Format）一文看懂：从老格式到单文件、静态方法的过渡" class="rounded-lg" width="1000" height="500" loading="lazy" decoding="async"> <h1 class="h2 text-left my-6">oTree 新写法（New Format）一文看懂：从老格式到单文件、静态方法的过渡</h1> <div class="content mb-16 text-left"> <p>我前阵子把一个老项目从 oTree 旧格式迁到“新写法”，一路踩坑，也把官方文档 <a href="https://www.otree.org/newformat.html">https://www.otree.org/newformat.html</a> 翻了个底朝天。下面这篇就按“能跑起来、能维护、能迁移”的思路，把新写法讲清楚。看完你就能用最新写法开工，或者把旧项目平稳升级。</p>
<hr>
<h2 id="一到底什么是新写法">一、到底什么是“新写法”</h2>
<ul>
<li>单文件：一个 app 用一个 Python 文件（通常是 app 目录下的 <code>__init__.py</code>）就能写完，不再分 <code>models.py / pages.py</code>。</li>
<li>Page/WaitPage 方法改成 <code>@staticmethod</code>，不再用 <code>self</code>；方法第一个参数直接拿到 <code>player/group/subsession</code>。</li>
<li>常量类从 <code>Constants</code> 简写为 <code>C</code>。</li>
<li>货币使用 <code>cu()</code>（currency utility），例如 <code>cu(100)</code>。</li>
<li>会话钩子与管理报表用模块级函数，例如 <code>creating_session(subsession)</code>、<code>vars_for_admin_report(subsession)</code>。</li>
</ul>
<p>这套新写法从 oTree 5 开始普及，官方推荐。写起来更短，减少“在类里套方法”的心智负担。</p>
<hr>
<h2 id="二最小可运行示例">二、最小可运行示例</h2>
<p>假设你的 app 叫 <code>survey</code>，目录结构大概是：</p>
<ul>
<li><code>survey/__init__.py</code></li>
<li><code>survey/templates/survey/Intro.html</code></li>
<li><code>survey/templates/survey/Results.html</code></li>
</ul>
<p><code>__init__.py</code> 示例：</p>
<pre class="astro-code one-dark-pro" style="background-color:#282c34;color:#abb2bf; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#C678DD">from</span><span style="color:#ABB2BF"> otree.api </span><span style="color:#C678DD">import</span><span style="color:#56B6C2"> *</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">doc </span><span style="color:#56B6C2">=</span><span style="color:#98C379"> """</span></span>
<span class="line"><span style="color:#98C379">一个最小示例：收年龄，展示结果</span></span>
<span class="line"><span style="color:#98C379">"""</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">class</span><span style="color:#E5C07B"> C</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">BaseConstants</span><span style="color:#ABB2BF">):</span></span>
<span class="line"><span style="color:#D19A66">    NAME_IN_URL</span><span style="color:#56B6C2"> =</span><span style="color:#98C379"> 'survey'</span></span>
<span class="line"><span style="color:#D19A66">    PLAYERS_PER_GROUP</span><span style="color:#56B6C2"> =</span><span style="color:#D19A66"> None</span></span>
<span class="line"><span style="color:#D19A66">    NUM_ROUNDS</span><span style="color:#56B6C2"> =</span><span style="color:#D19A66"> 1</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">class</span><span style="color:#E5C07B"> Subsession</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">BaseSubsession</span><span style="color:#ABB2BF">):</span></span>
<span class="line"><span style="color:#C678DD">    pass</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">class</span><span style="color:#E5C07B"> Group</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">BaseGroup</span><span style="color:#ABB2BF">):</span></span>
<span class="line"><span style="color:#C678DD">    pass</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">class</span><span style="color:#E5C07B"> Player</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">BasePlayer</span><span style="color:#ABB2BF">):</span></span>
<span class="line"><span style="color:#ABB2BF">    age </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> models.</span><span style="color:#61AFEF">IntegerField</span><span style="color:#ABB2BF">(</span><span style="color:#E06C75;font-style:italic">min</span><span style="color:#56B6C2">=</span><span style="color:#D19A66">18</span><span style="color:#ABB2BF">, </span><span style="color:#E06C75;font-style:italic">max</span><span style="color:#56B6C2">=</span><span style="color:#D19A66">99</span><span style="color:#ABB2BF">, </span><span style="color:#E06C75;font-style:italic">label</span><span style="color:#56B6C2">=</span><span style="color:#98C379">'你的年龄'</span><span style="color:#ABB2BF">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">class</span><span style="color:#E5C07B"> Intro</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">Page</span><span style="color:#ABB2BF">):</span></span>
<span class="line"><span style="color:#ABB2BF">    form_model </span><span style="color:#56B6C2">=</span><span style="color:#98C379"> 'player'</span></span>
<span class="line"><span style="color:#ABB2BF">    form_fields </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> [</span><span style="color:#98C379">'age'</span><span style="color:#ABB2BF">]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">class</span><span style="color:#E5C07B"> Results</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">Page</span><span style="color:#ABB2BF">):</span></span>
<span class="line"><span style="color:#61AFEF">    @</span><span style="color:#56B6C2">staticmethod</span></span>
<span class="line"><span style="color:#C678DD">    def</span><span style="color:#61AFEF"> vars_for_template</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66;font-style:italic">player</span><span style="color:#ABB2BF">: Player):</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#56B6C2"> dict</span><span style="color:#ABB2BF">(</span><span style="color:#E06C75;font-style:italic">age</span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF">player.age)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">page_sequence </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> [Intro, Results]</span></span>
<span class="line"></span></code></pre>
<p>对应模板 <code>Intro.html</code>：</p>
<pre class="astro-code one-dark-pro" style="background-color:#282c34;color:#abb2bf; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="html"><code><span class="line"><span style="color:#ABB2BF">{% block title %}填写信息{% endblock %}</span></span>
<span class="line"><span style="color:#ABB2BF">{% block content %}</span></span>
<span class="line"><span style="color:#ABB2BF">  {{ formfields }}</span></span>
<span class="line"><span style="color:#ABB2BF">  {{ next_button }}</span></span>
<span class="line"><span style="color:#ABB2BF">{% endblock %}</span></span>
<span class="line"></span></code></pre>
<p>对应模板 <code>Results.html</code>：</p>
<pre class="astro-code one-dark-pro" style="background-color:#282c34;color:#abb2bf; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="html"><code><span class="line"><span style="color:#ABB2BF">{% block title %}结果{% endblock %}</span></span>
<span class="line"><span style="color:#ABB2BF">{% block content %}</span></span>
<span class="line"><span style="color:#ABB2BF">  你的年龄是：{{ age }}</span></span>
<span class="line"><span style="color:#ABB2BF">  {{ next_button }}</span></span>
<span class="line"><span style="color:#ABB2BF">{% endblock %}</span></span>
<span class="line"></span></code></pre>
<hr>
<h2 id="三文件结构与命名规则和旧版有什么不同">三、文件结构与命名规则（和旧版有什么不同）</h2>
<ul>
<li>单文件：一个 app 只需要 <code>__init__.py</code>；以前的 <code>models.py</code>、<code>pages.py</code> 合并到一起。</li>
<li>常量类：<code>Constants → C</code>；属性仍是 <code>NAME_IN_URL / NUM_ROUNDS / PLAYERS_PER_GROUP</code>。</li>
<li>模板命名：模板文件名需与 <code>Page/WaitPage</code> 类名一致（<code>Intro → Intro.html</code>），并放在 <code>templates/你的app名/</code> 下。</li>
<li>页面顺序：<code>page_sequence = [PageA, PageB, ...]</code> 放在文件末尾。</li>
</ul>
<hr>
<h2 id="四页面方法全面静态方法风格">四、页面方法：全面“静态方法风格”</h2>
<p>常用方法对照（旧 → 新）：</p>
<ul>
<li><code>is_displayed(self)</code> → <code>@staticmethod is_displayed(player)</code></li>
<li><code>vars_for_template(self)</code> → <code>@staticmethod vars_for_template(player)</code></li>
<li><code>before_next_page(self, timeout_happened)</code> → <code>@staticmethod before_next_page(player, timeout_happened)</code></li>
<li><code>error_message(self, values)</code> → <code>@staticmethod error_message(player, values)</code></li>
<li><code>get_form_fields(self)</code> → <code>@staticmethod get_form_fields(player)</code>（动态表单时用）</li>
<li><code>get_timeout_seconds(self)</code> → <code>@staticmethod get_timeout_seconds(player)</code></li>
<li><code>js_vars(self)</code> → <code>@staticmethod js_vars(player)</code></li>
<li><code>app_after_this_page(self, upcoming_apps)</code> → <code>@staticmethod app_after_this_page(player, upcoming_apps)</code></li>
</ul>
<p>WaitPage 对照：</p>
<ul>
<li><code>after_all_players_arrive(self)</code> → <code>@staticmethod after_all_players_arrive(group)</code></li>
<li><code>is_displayed(self)</code> → <code>@staticmethod is_displayed(player)</code></li>
</ul>
<p>示例：动态表单字段与超时</p>
<pre class="astro-code one-dark-pro" style="background-color:#282c34;color:#abb2bf; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#C678DD">class</span><span style="color:#E5C07B"> Decide</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">Page</span><span style="color:#ABB2BF">):</span></span>
<span class="line"><span style="color:#61AFEF">    @</span><span style="color:#56B6C2">staticmethod</span></span>
<span class="line"><span style="color:#C678DD">    def</span><span style="color:#61AFEF"> get_form_fields</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66;font-style:italic">player</span><span style="color:#ABB2BF">: Player):</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        # 根据轮次动态变更</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#ABB2BF"> [</span><span style="color:#98C379">'age'</span><span style="color:#ABB2BF">] </span><span style="color:#C678DD">if</span><span style="color:#ABB2BF"> player.round_number </span><span style="color:#56B6C2">==</span><span style="color:#D19A66"> 1</span><span style="color:#C678DD"> else</span><span style="color:#ABB2BF"> []</span></span>
<span class="line"></span>
<span class="line"><span style="color:#61AFEF">    @</span><span style="color:#56B6C2">staticmethod</span></span>
<span class="line"><span style="color:#C678DD">    def</span><span style="color:#61AFEF"> get_timeout_seconds</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66;font-style:italic">player</span><span style="color:#ABB2BF">: Player):</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#D19A66"> 60</span></span>
<span class="line"></span></code></pre>
<hr>
<h2 id="五会话与匹配creating_session-等钩子的新写法">五、会话与匹配：creating_session 等“钩子”的新写法</h2>
<p>旧版很多逻辑写在类方法里（比如 <code>Subsession.creating_session</code>）。新写法直接写模块级函数：</p>
<pre class="astro-code one-dark-pro" style="background-color:#282c34;color:#abb2bf; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#C678DD">def</span><span style="color:#61AFEF"> creating_session</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66;font-style:italic">subsession</span><span style="color:#ABB2BF">: Subsession):</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    # 开场分组、处理 treatment、读取 session.config 等都在这里</span></span>
<span class="line"><span style="color:#C678DD">    if</span><span style="color:#ABB2BF"> subsession.round_number </span><span style="color:#56B6C2">==</span><span style="color:#D19A66"> 1</span><span style="color:#ABB2BF">:</span></span>
<span class="line"><span style="color:#ABB2BF">        subsession.</span><span style="color:#61AFEF">group_randomly</span><span style="color:#ABB2BF">()</span></span>
<span class="line"></span></code></pre>
<p>管理员报告：</p>
<pre class="astro-code one-dark-pro" style="background-color:#282c34;color:#abb2bf; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#C678DD">def</span><span style="color:#61AFEF"> vars_for_admin_report</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66;font-style:italic">subsession</span><span style="color:#ABB2BF">: Subsession):</span></span>
<span class="line"><span style="color:#ABB2BF">    players </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> subsession.</span><span style="color:#61AFEF">get_players</span><span style="color:#ABB2BF">()</span></span>
<span class="line"><span style="color:#C678DD">    return</span><span style="color:#56B6C2"> dict</span><span style="color:#ABB2BF">(</span><span style="color:#E06C75;font-style:italic">n_players</span><span style="color:#56B6C2">=len</span><span style="color:#ABB2BF">(players))</span></span>
<span class="line"></span></code></pre>
<hr>
<h2 id="六currency-的推荐写法cu">六、Currency 的推荐写法：cu()</h2>
<ul>
<li>推荐：<code>C.ENDOWMENT = cu(100)</code></li>
<li>模板里直接 <code>{{ C.ENDOWMENT }}</code> 会自动以货币格式显示</li>
<li>Python 中参与加减乘除时与数字类似，但保持货币类型</li>
</ul>
<p>示例：</p>
<pre class="astro-code one-dark-pro" style="background-color:#282c34;color:#abb2bf; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#C678DD">class</span><span style="color:#E5C07B"> C</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">BaseConstants</span><span style="color:#ABB2BF">):</span></span>
<span class="line"><span style="color:#D19A66">    ENDOWMENT</span><span style="color:#56B6C2"> =</span><span style="color:#61AFEF"> cu</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66">100</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#D19A66">    CONVERSION_RATE</span><span style="color:#56B6C2"> =</span><span style="color:#D19A66"> 0.2</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">class</span><span style="color:#E5C07B"> Player</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">BasePlayer</span><span style="color:#ABB2BF">):</span></span>
<span class="line"><span style="color:#ABB2BF">    payoff_tokens </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> models.</span><span style="color:#61AFEF">CurrencyField</span><span style="color:#ABB2BF">(</span><span style="color:#E06C75;font-style:italic">initial</span><span style="color:#56B6C2">=</span><span style="color:#61AFEF">cu</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66">0</span><span style="color:#ABB2BF">))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">class</span><span style="color:#E5C07B"> Results</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">Page</span><span style="color:#ABB2BF">):</span></span>
<span class="line"><span style="color:#61AFEF">    @</span><span style="color:#56B6C2">staticmethod</span></span>
<span class="line"><span style="color:#C678DD">    def</span><span style="color:#61AFEF"> vars_for_template</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66;font-style:italic">player</span><span style="color:#ABB2BF">: Player):</span></span>
<span class="line"><span style="color:#ABB2BF">        cash </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> player.payoff_tokens </span><span style="color:#56B6C2">*</span><span style="color:#ABB2BF"> C.</span><span style="color:#D19A66">CONVERSION_RATE</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#56B6C2"> dict</span><span style="color:#ABB2BF">(</span><span style="color:#E06C75;font-style:italic">cash</span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF">cash)</span></span>
<span class="line"></span></code></pre>
<hr>
<h2 id="七模板层的小技巧">七、模板层的小技巧</h2>
<ul>
<li>一键渲染所有字段：<code>{{ formfields }}</code>；渲染单个字段：<code>{{ formfield 'age' }}</code></li>
<li>下一步按钮：<code>{{ next_button }}</code></li>
<li>常见对象可直接用：<code>player / group / subsession / session / C</code></li>
<li>判断与循环使用 Jinja 语法：<code>{% if %}</code>、<code>{% for %}</code></li>
</ul>
<p>示例（显示分组编号）：</p>
<pre class="astro-code one-dark-pro" style="background-color:#282c34;color:#abb2bf; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="html"><code><span class="line"><span style="color:#ABB2BF">组号：{{ player.group.id_in_subsession }}</span></span>
<span class="line"></span></code></pre>
<hr>
<h2 id="八分组与到达式匹配group_by_arrival_time">八、分组与到达式匹配（group_by_arrival_time）</h2>
<p>等候页里仍然用类属性：</p>
<pre class="astro-code one-dark-pro" style="background-color:#282c34;color:#abb2bf; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#C678DD">class</span><span style="color:#E5C07B"> Match</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">WaitPage</span><span style="color:#ABB2BF">):</span></span>
<span class="line"><span style="color:#ABB2BF">    group_by_arrival_time </span><span style="color:#56B6C2">=</span><span style="color:#D19A66"> True</span></span>
<span class="line"></span>
<span class="line"><span style="color:#61AFEF">    @</span><span style="color:#56B6C2">staticmethod</span></span>
<span class="line"><span style="color:#C678DD">    def</span><span style="color:#61AFEF"> after_all_players_arrive</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66;font-style:italic">group</span><span style="color:#ABB2BF">: Group):</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        # 所有本组玩家到齐后执行</span></span>
<span class="line"><span style="color:#C678DD">        for</span><span style="color:#ABB2BF"> p </span><span style="color:#C678DD">in</span><span style="color:#ABB2BF"> group.</span><span style="color:#61AFEF">get_players</span><span style="color:#ABB2BF">():</span></span>
<span class="line"><span style="color:#ABB2BF">            p.payoff </span><span style="color:#56B6C2">=</span><span style="color:#61AFEF"> cu</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66">10</span><span style="color:#ABB2BF">)</span></span>
<span class="line"></span></code></pre>
<hr>
<h2 id="九从旧项目迁移一张替换清单">九、从旧项目迁移：一张“替换清单”</h2>
<ul>
<li>合并文件：把 <code>models.py</code>、<code>pages.py</code> 内容合并到 <code>__init__.py</code>。</li>
<li>常量类重命名：<code>class Constants → class C</code>。</li>
<li>方法改静态：
<ul>
<li><code>self → player</code>（Page），<code>self → group</code>（WaitPage），<code>self → subsession</code>（admin report）</li>
<li>如 <code>self.player.age → player.age</code>；<code>self.group → player.group</code></li>
</ul>
</li>
<li><code>creating_session</code>：
<ul>
<li>旧：<code>class Subsession(BaseSubsession): def creating_session(self): ...</code></li>
<li>新：<code>def creating_session(subsession): ...</code></li>
</ul>
</li>
<li>货币：
<ul>
<li>旧：<code>from otree.api import Currency as c</code> → 新：<code>from otree.api import cu</code>；把 <code>c(...)</code> 改为 <code>cu(...)</code></li>
</ul>
</li>
<li>模板路径：确认模板放在 <code>templates/你的app名/</code>，文件名与 Page 类对齐</li>
<li>导入：推荐 <code>from otree.api import *</code>（省事、版本兼容好）</li>
</ul>
<hr>
<h2 id="十常见坑位与排查">十、常见坑位与排查</h2>
<ul>
<li>模板找不到：通常是模板名与 Page 类名不一致，或放错目录（要放在 <code>templates/你的app名/</code>）。</li>
<li>忘记 <code>@staticmethod</code>：页面方法没加装饰器会报错，或者 <code>self</code> 未定义。</li>
<li><code>values</code> 使用：<code>error_message(player, values)</code> 里 <code>values</code> 是用户提交的数据 dict，字段名要和 <code>form_fields</code> 一致。</li>
<li>超时逻辑：<code>get_timeout_seconds</code> 返回 <code>None</code> 表示不设定超时；<code>before_next_page</code> 的 <code>timeout_happened</code> 参数用来区分是否因超时跳转。</li>
<li>机器人/自测：Bots 写法略有差异，升级后参考官方示例；确保 <code>yield PageName, dict(...)</code> 的字段名与 <code>form_fields</code> 对齐。</li>
</ul>
<hr>
<h2 id="十一一个稍完整的演示含-waitpage-与结算">十一、一个稍完整的演示（含 WaitPage 与结算）</h2>
<pre class="astro-code one-dark-pro" style="background-color:#282c34;color:#abb2bf; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#C678DD">from</span><span style="color:#ABB2BF"> otree.api </span><span style="color:#C678DD">import</span><span style="color:#56B6C2"> *</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">class</span><span style="color:#E5C07B"> C</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">BaseConstants</span><span style="color:#ABB2BF">):</span></span>
<span class="line"><span style="color:#D19A66">    NAME_IN_URL</span><span style="color:#56B6C2"> =</span><span style="color:#98C379"> 'pg'</span></span>
<span class="line"><span style="color:#D19A66">    PLAYERS_PER_GROUP</span><span style="color:#56B6C2"> =</span><span style="color:#D19A66"> 4</span></span>
<span class="line"><span style="color:#D19A66">    NUM_ROUNDS</span><span style="color:#56B6C2"> =</span><span style="color:#D19A66"> 1</span></span>
<span class="line"><span style="color:#D19A66">    ENDOWMENT</span><span style="color:#56B6C2"> =</span><span style="color:#61AFEF"> cu</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66">20</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#D19A66">    MPCR</span><span style="color:#56B6C2"> =</span><span style="color:#D19A66"> 0.5</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">class</span><span style="color:#E5C07B"> Subsession</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">BaseSubsession</span><span style="color:#ABB2BF">):</span></span>
<span class="line"><span style="color:#C678DD">    pass</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">class</span><span style="color:#E5C07B"> Group</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">BaseGroup</span><span style="color:#ABB2BF">):</span></span>
<span class="line"><span style="color:#ABB2BF">    total_contrib </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> models.</span><span style="color:#61AFEF">CurrencyField</span><span style="color:#ABB2BF">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">class</span><span style="color:#E5C07B"> Player</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">BasePlayer</span><span style="color:#ABB2BF">):</span></span>
<span class="line"><span style="color:#ABB2BF">    contrib </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> models.</span><span style="color:#61AFEF">CurrencyField</span><span style="color:#ABB2BF">(</span><span style="color:#E06C75;font-style:italic">min</span><span style="color:#56B6C2">=</span><span style="color:#D19A66">0</span><span style="color:#ABB2BF">, </span><span style="color:#E06C75;font-style:italic">max</span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF">C.</span><span style="color:#D19A66">ENDOWMENT</span><span style="color:#ABB2BF">, </span><span style="color:#E06C75;font-style:italic">label</span><span style="color:#56B6C2">=</span><span style="color:#98C379">'你愿意投入公共账户的金额'</span><span style="color:#ABB2BF">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">def</span><span style="color:#61AFEF"> creating_session</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66;font-style:italic">subsession</span><span style="color:#ABB2BF">: Subsession):</span></span>
<span class="line"><span style="color:#C678DD">    if</span><span style="color:#ABB2BF"> subsession.round_number </span><span style="color:#56B6C2">==</span><span style="color:#D19A66"> 1</span><span style="color:#ABB2BF">:</span></span>
<span class="line"><span style="color:#ABB2BF">        subsession.</span><span style="color:#61AFEF">group_randomly</span><span style="color:#ABB2BF">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">class</span><span style="color:#E5C07B"> Contribute</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">Page</span><span style="color:#ABB2BF">):</span></span>
<span class="line"><span style="color:#ABB2BF">    form_model </span><span style="color:#56B6C2">=</span><span style="color:#98C379"> 'player'</span></span>
<span class="line"><span style="color:#ABB2BF">    form_fields </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> [</span><span style="color:#98C379">'contrib'</span><span style="color:#ABB2BF">]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">class</span><span style="color:#E5C07B"> WaitAll</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">WaitPage</span><span style="color:#ABB2BF">):</span></span>
<span class="line"><span style="color:#61AFEF">    @</span><span style="color:#56B6C2">staticmethod</span></span>
<span class="line"><span style="color:#C678DD">    def</span><span style="color:#61AFEF"> after_all_players_arrive</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66;font-style:italic">group</span><span style="color:#ABB2BF">: Group):</span></span>
<span class="line"><span style="color:#ABB2BF">        total </span><span style="color:#56B6C2">=</span><span style="color:#56B6C2"> sum</span><span style="color:#ABB2BF">(p.contrib </span><span style="color:#C678DD">for</span><span style="color:#ABB2BF"> p </span><span style="color:#C678DD">in</span><span style="color:#ABB2BF"> group.</span><span style="color:#61AFEF">get_players</span><span style="color:#ABB2BF">())</span></span>
<span class="line"><span style="color:#ABB2BF">        group.total_contrib </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> total</span></span>
<span class="line"><span style="color:#C678DD">        for</span><span style="color:#ABB2BF"> p </span><span style="color:#C678DD">in</span><span style="color:#ABB2BF"> group.</span><span style="color:#61AFEF">get_players</span><span style="color:#ABB2BF">():</span></span>
<span class="line"><span style="color:#ABB2BF">            private </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> C.</span><span style="color:#D19A66">ENDOWMENT</span><span style="color:#56B6C2"> -</span><span style="color:#ABB2BF"> p.contrib</span></span>
<span class="line"><span style="color:#ABB2BF">            share </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> total </span><span style="color:#56B6C2">*</span><span style="color:#ABB2BF"> C.</span><span style="color:#D19A66">MPCR</span><span style="color:#56B6C2"> /</span><span style="color:#ABB2BF"> C.</span><span style="color:#D19A66">PLAYERS_PER_GROUP</span></span>
<span class="line"><span style="color:#ABB2BF">            p.payoff </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> private </span><span style="color:#56B6C2">+</span><span style="color:#ABB2BF"> share</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">class</span><span style="color:#E5C07B"> Results</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">Page</span><span style="color:#ABB2BF">):</span></span>
<span class="line"><span style="color:#61AFEF">    @</span><span style="color:#56B6C2">staticmethod</span></span>
<span class="line"><span style="color:#C678DD">    def</span><span style="color:#61AFEF"> vars_for_template</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66;font-style:italic">player</span><span style="color:#ABB2BF">: Player):</span></span>
<span class="line"><span style="color:#ABB2BF">        g </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> player.group</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#56B6C2"> dict</span><span style="color:#ABB2BF">(</span></span>
<span class="line"><span style="color:#E06C75;font-style:italic">            total</span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF">g.total_contrib,</span></span>
<span class="line"><span style="color:#E06C75;font-style:italic">            my_contrib</span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF">player.contrib,</span></span>
<span class="line"><span style="color:#E06C75;font-style:italic">            payoff</span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF">player.payoff,</span></span>
<span class="line"><span style="color:#ABB2BF">        )</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">page_sequence </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> [Contribute, WaitAll, Results]</span></span>
<span class="line"></span></code></pre>
<p>模板 <code>Contribute.html</code>：</p>
<pre class="astro-code one-dark-pro" style="background-color:#282c34;color:#abb2bf; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="html"><code><span class="line"><span style="color:#ABB2BF">{% block title %}公共品决策{% endblock %}</span></span>
<span class="line"><span style="color:#ABB2BF">{% block content %}</span></span>
<span class="line"><span style="color:#ABB2BF">  你的初始资金：{{ C.ENDOWMENT }}</span></span>
<span class="line"><span style="color:#ABB2BF">  {{ formfields }}</span></span>
<span class="line"><span style="color:#ABB2BF">  {{ next_button }}</span></span>
<span class="line"><span style="color:#ABB2BF">{% endblock %}</span></span>
<span class="line"></span></code></pre>
<p>模板 <code>Results.html</code>：</p>
<pre class="astro-code one-dark-pro" style="background-color:#282c34;color:#abb2bf; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="html"><code><span class="line"><span style="color:#ABB2BF">{% block title %}结果{% endblock %}</span></span>
<span class="line"><span style="color:#ABB2BF">{% block content %}</span></span>
<span class="line"><span style="color:#ABB2BF">  本组总投入：{{ total }}&#x3C;</span><span style="color:#E06C75">br</span><span style="color:#ABB2BF">></span></span>
<span class="line"><span style="color:#ABB2BF">  你的投入：{{ my_contrib }}&#x3C;</span><span style="color:#E06C75">br</span><span style="color:#ABB2BF">></span></span>
<span class="line"><span style="color:#ABB2BF">  你的收益：{{ payoff }}</span></span>
<span class="line"><span style="color:#ABB2BF">  {{ next_button }}</span></span>
<span class="line"><span style="color:#ABB2BF">{% endblock %}</span></span>
<span class="line"></span></code></pre>
<hr>
<h2 id="结语">结语</h2>
<p>新写法的核心就三点：单文件、静态方法、<code>cu()</code>。上手成本不高，但能让代码更短更清晰。若你是从老项目迁移，先把“替换清单”过一遍，再逐页跑通；若是新项目，直接按“最小示例”搭骨架，边写边跑最省心。</p>
<p>如果你已经在用新写法，也欢迎把你遇到的坑留言交流。祝大家实验顺利、部署无坑、数据好看！</p> <!-- <Markdown content={post.body} components={shortcodes} /> --> </div> </article> </div> </div> </div> </section>  </main> <footer class="section bg-theme-light pb-0"> <div class="container">  <div class="row"> <div class="mb-12 sm:col-6 lg:col-3"> <h2 class="h4">Company</h2> <ul class="mt-6"> <li class="mb-1"> <a href="/pricing" rel=""> Pricing </a> </li><li class="mb-1"> <a href="#" rel=""> Quick Start </a> </li> </ul> </div><div class="mb-12 sm:col-6 lg:col-3"> <h2 class="h4">Product</h2> <ul class="mt-6"> <li class="mb-1"> <a href="#" rel=""> Features </a> </li><li class="mb-1"> <a href="#" rel=""> Platform </a> </li><li class="mb-1"> <a href="/pricing" rel=""> Pricing </a> </li> </ul> </div><div class="mb-12 sm:col-6 lg:col-3"> <h2 class="h4">Support</h2> <ul class="mt-6"> <li class="mb-1"> <a href="/faq" rel=""> FAQ </a> </li><li class="mb-1"> <a href="/privacy-policy" rel=""> Privacy Policy </a> </li><li class="mb-1"> <a href="/terms-conditions" rel=""> Terms &amp; Conditions </a> </li> </ul> </div>  <div class="md-12 sm:col-6 lg:col-3"> <a href="/" aria-label="Bigspring"> <img src="/images/logo5.png" alt="" width="200" height="38" loading="lazy" decoding="async"> </a> <p class="mt-3 mb-6">一站式oTree开发服务，耐心细致的服务。一站式oTree开发服务，耐心细致的服务，确保项目顺利进行。专业团队，全程陪伴，满足您的需求。</p> <ul class="social-icons mb-8"> <li class="inline-block"> <a aria-label="facebook" href="https://facebook.com/" target="_blank" rel="noopener noreferrer nofollow"> <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 512 512" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M480 257.35c0-123.7-100.3-224-224-224s-224 100.3-224 224c0 111.8 81.9 204.47 189 221.29V322.12h-56.89v-64.77H221V208c0-56.13 33.45-87.16 84.61-87.16 24.51 0 50.15 4.38 50.15 4.38v55.13H327.5c-27.81 0-36.51 17.26-36.51 35v42h62.12l-9.92 64.77H291v156.54c107.1-16.81 189-109.48 189-221.31z"></path></svg> </a> </li> <li class="inline-block"> <a aria-label="twitter" href="https://twitter.com/" target="_blank" rel="noopener noreferrer nofollow"> <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 512 512" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M496 109.5a201.8 201.8 0 0 1-56.55 15.3 97.51 97.51 0 0 0 43.33-53.6 197.74 197.74 0 0 1-62.56 23.5A99.14 99.14 0 0 0 348.31 64c-54.42 0-98.46 43.4-98.46 96.9a93.21 93.21 0 0 0 2.54 22.1 280.7 280.7 0 0 1-203-101.3A95.69 95.69 0 0 0 36 130.4c0 33.6 17.53 63.3 44 80.7A97.5 97.5 0 0 1 35.22 199v1.2c0 47 34 86.1 79 95a100.76 100.76 0 0 1-25.94 3.4 94.38 94.38 0 0 1-18.51-1.8c12.51 38.5 48.92 66.5 92.05 67.3A199.59 199.59 0 0 1 39.5 405.6a203 203 0 0 1-23.5-1.4A278.68 278.68 0 0 0 166.74 448c181.36 0 280.44-147.7 280.44-275.8 0-4.2-.11-8.4-.31-12.5A198.48 198.48 0 0 0 496 109.5z"></path></svg> </a> </li>  <li class="inline-block"> <a aria-label="instagram" href="https://instagram.com/" target="_blank" rel="noopener noreferrer nofollow"> <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 512 512" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M349.33 69.33a93.62 93.62 0 0 1 93.34 93.34v186.66a93.62 93.62 0 0 1-93.34 93.34H162.67a93.62 93.62 0 0 1-93.34-93.34V162.67a93.62 93.62 0 0 1 93.34-93.34h186.66m0-37.33H162.67C90.8 32 32 90.8 32 162.67v186.66C32 421.2 90.8 480 162.67 480h186.66C421.2 480 480 421.2 480 349.33V162.67C480 90.8 421.2 32 349.33 32z"></path><path d="M377.33 162.67a28 28 0 1 1 28-28 27.94 27.94 0 0 1-28 28zM256 181.33A74.67 74.67 0 1 1 181.33 256 74.75 74.75 0 0 1 256 181.33m0-37.33a112 112 0 1 0 112 112 112 112 0 0 0-112-112z"></path></svg> </a> </li>  <li class="inline-block"> <a aria-label="linkedin" href="https://linkedin.com/" target="_blank" rel="noopener noreferrer nofollow"> <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 512 512" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M444.17 32H70.28C49.85 32 32 46.7 32 66.89v374.72C32 461.91 49.85 480 70.28 480h373.78c20.54 0 35.94-18.21 35.94-38.39V66.89C480.12 46.7 464.6 32 444.17 32zm-273.3 373.43h-64.18V205.88h64.18zM141 175.54h-.46c-20.54 0-33.84-15.29-33.84-34.43 0-19.49 13.65-34.42 34.65-34.42s33.85 14.82 34.31 34.42c-.01 19.14-13.31 34.43-34.66 34.43zm264.43 229.89h-64.18V296.32c0-26.14-9.34-44-32.56-44-17.74 0-28.24 12-32.91 23.69-1.75 4.2-2.22 9.92-2.22 15.76v113.66h-64.18V205.88h64.18v27.77c9.34-13.3 23.93-32.44 57.88-32.44 42.13 0 74 27.77 74 87.64z"></path></svg> </a> </li>                          </ul> </div> </div>  <div class="border-t border-border py-6 flex gap-2"> <p class="text-sm text-center">Designed and Developed By oTree Study</p> </div> </div> </footer> <!-- Google tag (gtag.js) --> <script async src="https://www.googletagmanager.com/gtag/js?id=G-RN1NCJ00WE"></script>  </body> </html>